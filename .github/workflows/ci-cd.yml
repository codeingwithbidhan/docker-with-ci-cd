name: Docker laravel-react with CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1-6: (Unchanged)
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build & Push Laravel Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          file: ./backend/Dockerfile.production
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/laravel-backend:latest

      - name: Build & Push React Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          file: ./frontend/Dockerfile.production
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/react-frontend:latest


      - name: Copy Docker Compose File to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.AWS_PORT }}
          source: "docker-compose.production.yml" 
          target: "/home/${{ secrets.SERVER_USER }}/docker-with-ci-cd"

      # üí° ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§ Step 7: ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ö‡ßá‡¶ï ‡¶ì ‡¶á‡¶Æ‡ßá‡¶ú ‡¶™‡ßÅ‡¶≤ ‡¶ï‡¶∞‡¶æ
      - name: Pull Latest Docker Images & Create ENV
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.AWS_PORT }}
          command_timeout: 20m 

          script: |
            TARGET_DIR=/home/${{ secrets.SERVER_USER }}/docker-with-ci-cd
            mkdir -p $TARGET_DIR
            cd $TARGET_DIR
            
            if [ ! -f "docker-compose.production.yml" ]; then
                echo "Error: docker-compose.production.yml file NOT FOUND in $TARGET_DIR";
                ls -la 
                exit 1;
            fi
            
            echo "Creating .env file from secrets..."
            echo "DB_DATABASE=${{ secrets.DB_DATABASE }}" > .env
            echo "DB_USERNAME=${{ secrets.DB_USERNAME }}" >> .env
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env
            echo "DB_ROOT_PASSWORD=${{ secrets.DB_ROOT_PASSWORD }}" >> .env
            
            sudo docker-compose -f docker-compose.production.yml down || true
            sudo docker image prune -f || true
            
            echo "Starting Image Pull..."
            sudo docker-compose -f docker-compose.production.yml pull
            echo "Image Pull Complete."

      # üîç ‡¶°‡¶æ‡¶Ø‡¶º‡¶æ‡¶ó‡¶®‡¶∏‡ßç‡¶ü‡¶ø‡¶ï ‡¶ß‡¶æ‡¶™: ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ï‡¶®‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ (‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§)
      - name: Verify Docker Compose Content on Server
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.AWS_PORT }}
          
          script: |
            cd /home/${{ secrets.SERVER_USER }}/docker-with-ci-cd
            echo "--- VERIFYING CURRENT docker-compose.production.yml CONTENT ---"
            cat docker-compose.production.yml
            echo "---------------------------------------------------------------"

      # üí° ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶° Step 7.5: ‡¶®‡¶®-‡¶¨‡ßç‡¶≤‡¶ï‡¶ø‡¶Ç ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü
      - name: Start Docker Containers (Non-Blocking)
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.AWS_PORT }}
          # üö® ‡¶ü‡¶æ‡¶á‡¶Æ‡¶Ü‡¶â‡¶ü ‡ßß ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü, ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°‡¶ü‡¶ø ‡¶§‡¶æ‡ßé‡¶ï‡ßç‡¶∑‡¶£‡¶ø‡¶ï ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶°‡ßá ‡¶ö‡¶≤‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá
          command_timeout: 1m 

          script: |
            cd /home/${{ secrets.SERVER_USER }}/docker-with-ci-cd
            
            echo "Starting containers in background to bypass SSH block..."
            # üö® ‡¶ö‡ßÇ‡¶°‡¶º‡¶æ‡¶®‡ßç‡¶§ ‡¶´‡¶ø‡¶ï‡ßç‡¶∏: nohup ‡¶ì & ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§ ‡¶è‡¶ü‡¶ø SSH ‡¶¨‡ßç‡¶≤‡¶ï ‡¶è‡¶°‡¶º‡¶ø‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§
            nohup sudo docker-compose -f docker-compose.production.yml up -d --force-recreate --remove-orphans > /dev/null 2>&1 &
            
            echo "Docker Compose started in background. Checking current status..."
            # ‡¶§‡¶æ‡ßé‡¶ï‡ßç‡¶∑‡¶£‡¶ø‡¶ï ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ö‡ßá‡¶ï
            sudo docker-compose -f docker-compose.production.yml ps
            
            echo "Step 7.5 finished successfully (non-blocking)."
            # ‡¶è‡¶á ‡¶ß‡¶æ‡¶™‡¶ü‡¶ø ‡¶è‡¶ñ‡¶® ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶ü‡¶æ‡¶á‡¶Æ‡¶Ü‡¶â‡¶ü ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§

      # Step 8: Run Database Migrations (‡¶ó‡ßç‡¶Ø‡¶æ‡¶∞‡¶æ‡¶®‡ßç‡¶ü‡ßá‡¶° ‡¶ì‡ßü‡ßá‡¶ü ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§)
      - name: Run Database Migrations and Debug Logs
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.AWS_PORT }}
          command_timeout: 5m
          
          script: |
            cd /home/${{ secrets.SERVER_USER }}/docker-with-ci-cd
            
            # üö® ‡¶ó‡ßç‡¶Ø‡¶æ‡¶∞‡¶æ‡¶®‡ßç‡¶ü‡ßá‡¶° ‡¶ì‡ßü‡ßá‡¶ü: Step 7.5 ‡¶®‡¶®-‡¶¨‡ßç‡¶≤‡¶ï‡¶ø‡¶Ç ‡¶π‡¶ì‡ßü‡¶æ‡ßü, ‡¶è‡¶á ‡¶ß‡¶æ‡¶™‡ßá‡¶á ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü‡¶Ü‡¶™‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶¨‡•§
            echo "Waiting 60 seconds for all containers to fully start and stabilize..."
            sleep 60
            
            # LARAVEL ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ
            LARAVEL_CONTAINER_NAME=$(sudo docker-compose -f docker-compose.production.yml ps -q backend) 
            
            if [ -n "$LARAVEL_CONTAINER_NAME" ]; then
              CONTAINER_STATUS=$(sudo docker inspect -f '{{.State.Status}}' $LARAVEL_CONTAINER_NAME)

              if [ "$CONTAINER_STATUS" = "running" ]; then
                  echo "Backend container is RUNNING. Running Migrations...";
                  # DB ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶§‡¶ø‡¶∞‡¶ø‡¶ï‡ßç‡¶§ 10 ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶æ
                  echo "Waiting 10 seconds for DB connection establishment...";
                  sleep 10
                  
                  sudo docker exec $LARAVEL_CONTAINER_NAME php artisan migrate --force;
                  sudo docker exec $LARAVEL_CONTAINER_NAME php artisan cache:clear;
                  echo "Deployment successful!";
              else
                  echo "Error: Backend container found but status is NOT RUNNING ($CONTAINER_STATUS).";
                  
                  # üö® ‡¶°‡¶ø‡¶¨‡¶æ‡¶ó‡¶ø‡¶Ç: ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞‡¶ü‡¶ø ‡¶ï‡ßá‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá ‡¶§‡¶æ‡¶∞ ‡¶≤‡¶ó ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
                  echo "--- Printing Backend Container Logs ---"
                  sudo docker-compose -f docker-compose.production.yml logs backend
                  
                  # üö® ‡¶°‡¶ø‡¶¨‡¶æ‡¶ó‡¶ø‡¶Ç: ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶è‡¶ï‡ßç‡¶∏‡¶ø‡¶ü ‡¶ï‡ßã‡¶° ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
                  echo "--- Container Status Check ---"
                  sudo docker-compose -f docker-compose.production.yml ps
                  
                  exit 1;
              fi
            else
              echo "Error: Backend container not found. Checking logs...";
              sudo docker-compose -f docker-compose.production.yml logs 
              sudo docker-compose -f docker-compose.production.yml ps
              exit 1;
            fi
